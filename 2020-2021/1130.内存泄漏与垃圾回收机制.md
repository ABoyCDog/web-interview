# 一、内存泄漏

## 1、什么是内存泄漏

**`内存泄漏，memory leak，是指程序中已动态分配的堆内存由于某种原因导致程序未释放或无法释放，造成系统内存的浪费，导致程序运行速度减慢甚至系统奔溃等严重后果`**

简单说就是，不用到的内存没有及时释放，就会造成内存泄漏。

c 语言必须手动释放内存，使用`malloc`申请内存，`free`释放内存。手动释放很麻烦，所以大多数语言都有提供自动内存管理，就是 `垃圾回收机制(garnage collector)`

## 2、内存

程序的运行需要内存。只要程序提出要求，操作系统或运行时 runtime 必须供给内存。

JS 使用的内存主要是堆内存和栈内存

- 堆内存(heap)：使用堆数据结构，堆允许程序运行时动态申请某个大小的内存空间
- 栈内存(stack)：使用栈数据结构，栈是一种先进后出的数据结构

比喻：堆内存就像是自己动手做菜，口味由自己决定，比较麻烦，但是自由度很大；栈内存就像是去饭店吃，点菜(申请)、付钱和吃(使用)，好处就是方便，不用自己动手做菜，就是可能口味不合，相对自由度小。

# 二、垃圾回收

## 1、哪些是垃圾

一般来说，没有被引用的对象就是垃圾。如果几个对象之间相互引用形成环，但是没有被根 root 引用也就是根 root 找不到他们，那也是垃圾。

## 2、如何判断垃圾

最常使用的方法就是`引用计数(reference counting)`：语言引擎有一张‘引用表’，保存了内存里所有的资源(通常是所有值)的引用次数。如果一个值的引用次数是 0，那么这个值就用不到了，就是垃圾，就应该将这个值所占用的内存释放。

## 3、是垃圾但无法释放

一个值不需要了，但是引用次数不为 0，导致垃圾回收机制无法回收这块内存，就会导致内存泄漏。

```js
const arr = [1, 2, 3];
console.log("garbage collector!");
```

上面代码中数组[1,2,3]是一个值，arr 是对它的唯一引用，变量 arr 被引用了一次，但其实没被根 root 引用到，其实也是垃圾，但这个引用计数的算法来说就没法被回收。

# 三、内存泄漏的识别方法

如何观察到内存泄漏呢？

有些是判别是，如果连续五次垃圾回收之后，内存占用一次比一次大，就有内存泄漏。这就要求查看实时内存占用。

- 命令行
  命令行可以使用 Node 提供的 process.memoryUsage 方法。

```js
console.log(process.memoryUsage());
// { rss: 27709440,
//  heapTotal: 5685248,
//  heapUsed: 3449392,
//  external: 8772 }
```

process.memoryUsage 返回一个对象，包含了 Node 进程的内存占用信息。

> rss（resident set size）：所有内存占用，包括指令区和堆栈。

> heapTotal："堆"占用的内存，包括用到的和没用到的。

> heapUsed：用到的堆的部分。

> external： V8 引擎内部的 C++ 对象占用的内存。

判断内存泄漏，以 heapUsed 字段为准。

# 四、WeakMap

及时清除引用，最好能有一种方法，在新建引用的时候就声明，哪些引用必须手动清除，哪些引用可以忽略不计，当其他引用消失以后，垃圾回收机制就可以释放内存。这样就能大大减轻程序员的负担，你只要清除主要引用就可以了。

ES6 考虑到了这一点，推出了两种新的数据结构：WeakSet 和 WeakMap。它们对于值的引用都是不计入垃圾回收机制的，所以名字里面才会有一个"Weak"，表示这是弱引用。

下面以 WeakMap 为例，看看它是怎么解决内存泄漏的。

```js
const wm = new WeakMap();

const element = document.getElementById("example");

wm.set(element, "some information");
wm.get(element); // "some information"
```

上面代码中，先新建一个 Weakmap 实例。然后，将一个 DOM 节点作为键名存入该实例，并将一些附加信息作为键值，一起存放在 WeakMap 里面。这时，WeakMap 里面对 element 的引用就是弱引用，不会被计入垃圾回收机制。

也就是说，DOM 节点对象的引用计数是 1，而不是 2。这时，一旦消除对该节点的引用，它占用的内存就会被垃圾回收机制释放。Weakmap 保存的这个键值对，也会自动消失。

基本上，如果你要往对象上添加数据，又不想干扰垃圾回收机制，就可以使用 WeakMap。
